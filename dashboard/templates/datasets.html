{% extends "base.html" %}

{% block title %}Datasets - Advanced LLMs Cybersecurity{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">
        <i class="fas fa-database me-2"></i>
        Dataset Management
    </h1>
    <div>
        <button class="btn btn-success me-2" onclick="downloadMissingDatasets()">
            <i class="fas fa-download me-1"></i>
            Download Missing
        </button>
        <button class="btn btn-primary" onclick="refreshDatasets()">
            <i class="fas fa-sync-alt me-1"></i>
            Refresh
        </button>
    </div>
</div>

<!-- Dataset Status Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value text-success" id="available-datasets">-</div>
            <div class="metric-label">Available Datasets</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value text-warning" id="missing-datasets">-</div>
            <div class="metric-label">Missing Datasets</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value text-info" id="total-datasets">-</div>
            <div class="metric-label">Total Datasets</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card">
            <div class="metric-value text-primary" id="data-size">-</div>
            <div class="metric-label">Total Data Size</div>
        </div>
    </div>
</div>

<!-- Datasets Table -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-table me-2"></i>
        Dataset Details
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="datasets-table">
                <thead>
                    <tr>
                        <th>Dataset Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Path</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="datasets-tbody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading datasets...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Download Progress Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>
                    Downloading Datasets
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="download-progress"></div>
                </div>
                <div id="download-status">Preparing download...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let datasetsData = {};

function refreshDatasets() {
    loadDatasets();
}

function loadDatasets() {
    fetch('/api/system-status')
        .then(response => response.json())
        .then(data => {
            datasetsData = data.datasets || {};
            updateDatasetMetrics(data);
            updateDatasetsTable(data.datasets || {});
        })
        .catch(error => {
            console.error('Error loading datasets:', error);
            document.getElementById('datasets-tbody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error loading datasets</td></tr>';
        });
}

function updateDatasetMetrics(data) {
    const datasets = data.datasets || {};
    const available = Object.values(datasets).filter(d => d.exists).length;
    const missing = Object.values(datasets).filter(d => !d.exists).length;
    const total = Object.keys(datasets).length;
    
    document.getElementById('available-datasets').textContent = available;
    document.getElementById('missing-datasets').textContent = missing;
    document.getElementById('total-datasets').textContent = total;
    document.getElementById('data-size').textContent = 'Calculating...';
}

function updateDatasetsTable(datasets) {
    const tbody = document.getElementById('datasets-tbody');
    
    if (Object.keys(datasets).length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No datasets found</td></tr>';
        return;
    }
    
    let html = '';
    Object.entries(datasets).forEach(([name, info]) => {
        const statusBadge = info.exists ? 
            '<span class="badge bg-success">Available</span>' : 
            '<span class="badge bg-warning">Missing</span>';
        
        const actionButton = info.exists ? 
            `<button class="btn btn-sm btn-outline-info" onclick="viewDataset('${name}')">
                <i class="fas fa-eye"></i> View
            </button>` :
            `<button class="btn btn-sm btn-outline-primary" onclick="downloadDataset('${name}')">
                <i class="fas fa-download"></i> Download
            </button>`;
        
        html += `
            <tr>
                <td>
                    <strong>${name.replace(/_/g, ' ').toUpperCase()}</strong>
                </td>
                <td>${info.description}</td>
                <td>${statusBadge}</td>
                <td><code>${info.path}</code></td>
                <td>${actionButton}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function downloadDataset(datasetName) {
    const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
    modal.show();
    
    const progressBar = document.getElementById('download-progress');
    const statusDiv = document.getElementById('download-status');
    
    statusDiv.textContent = `Downloading ${datasetName}...`;
    progressBar.style.width = '20%';
    
    // Simulate download progress
    let progress = 20;
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 500);
    
    // Simulate download completion after 3 seconds
    setTimeout(() => {
        clearInterval(interval);
        progressBar.style.width = '100%';
        statusDiv.innerHTML = `<i class="fas fa-check text-success me-2"></i>Download completed successfully!`;
        
        setTimeout(() => {
            modal.hide();
            refreshDatasets();
        }, 1500);
    }, 3000);
}

function downloadMissingDatasets() {
    const missingDatasets = Object.entries(datasetsData)
        .filter(([name, info]) => !info.exists)
        .map(([name, info]) => name);
    
    if (missingDatasets.length === 0) {
        alert('All datasets are already available!');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
    modal.show();
    
    const progressBar = document.getElementById('download-progress');
    const statusDiv = document.getElementById('download-status');
    
    statusDiv.textContent = `Downloading ${missingDatasets.length} missing datasets...`;
    
    let currentDataset = 0;
    const downloadNext = () => {
        if (currentDataset >= missingDatasets.length) {
            progressBar.style.width = '100%';
            statusDiv.innerHTML = `<i class="fas fa-check text-success me-2"></i>All downloads completed!`;
            setTimeout(() => {
                modal.hide();
                refreshDatasets();
            }, 1500);
            return;
        }
        
        const datasetName = missingDatasets[currentDataset];
        statusDiv.textContent = `Downloading ${datasetName}... (${currentDataset + 1}/${missingDatasets.length})`;
        
        const progress = ((currentDataset + 1) / missingDatasets.length) * 100;
        progressBar.style.width = progress + '%';
        
        currentDataset++;
        setTimeout(downloadNext, 1000);
    };
    
    downloadNext();
}

function viewDataset(datasetName) {
    const dataset = datasetsData[datasetName];
    if (!dataset) return;
    
    alert(`Dataset: ${datasetName}\nDescription: ${dataset.description}\nPath: ${dataset.path}\nStatus: ${dataset.exists ? 'Available' : 'Missing'}`);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
});
</script>
{% endblock %}